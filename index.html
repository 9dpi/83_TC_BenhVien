<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>83 Tiêu chí - Digital Phụ lục 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #05070a;
            --card: #111827;
            --primary: #3b82f6;
        }

        body {
            background: var(--bg);
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* Dashboard */
        .header-ds {
            height: 70px;
            background: var(--card);
            border-bottom: 1px solid #1f2937;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 30px;
        }

        .energy-bar {
            flex-grow: 1;
            height: 6px;
            background: #1f2937;
            border-radius: 3px;
            position: relative;
        }

        #energy-fill {
            height: 100%;
            width: 0%;
            background: var(--primary);
            border-radius: 3px;
            transition: 1s;
            box-shadow: 0 0 10px var(--primary);
        }

        .main-container {
            display: grid;
            grid-template-columns: 450px 1fr;
            height: calc(100vh - 70px);
        }

        /* List Tiêu chí */
        #info-panel {
            background: #0f172a;
            border-right: 1px solid #1e293b;
            padding: 20px;
            overflow-y: auto;
        }

        .phuluc-card {
            background: #1e293b;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid transparent;
            transition: 0.3s;
            cursor: pointer;
        }

        .phuluc-card.active {
            border-color: var(--primary);
            background: #161e31;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
        }

        .level-tag {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: white;
        }

        .lvl-1 {
            background: #ef4444;
        }

        .lvl-2 {
            background: #f97316;
        }

        .lvl-3 {
            background: #eab308;
        }

        .lvl-4 {
            background: #22c55e;
        }

        .lvl-5 {
            background: #06b6d4;
        }

        /* Detail Box (Phụ lục 3) */
        .appendix-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #334155;
            font-size: 12px;
        }

        .phuluc-card.active .appendix-content {
            display: block;
        }

        .label-pl {
            color: #60a5fa;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 10px;
            display: block;
            margin-bottom: 2px;
        }

        /* Map */
        #hospital-frame {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            overflow: hidden;
        }

        .hotspot {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #fff;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 100;
        }

        #connection-svg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 50;
        }
    </style>
</head>

<body>
    <svg id="connection-svg">
        <path id="connector-line" d="" fill="none" stroke="#3b82f6" stroke-width="1.5" stroke-dasharray="5,3" />
    </svg>

    <div class="header-ds">
        <div>
            <h1 class="text-sm font-black text-blue-500 uppercase">Hệ thống 83 Tiêu chí</h1>
            <p class="text-[9px] opacity-50 italic">Digital Phụ lục 3 BYT</p>
        </div>
        <div class="energy-bar">
            <div id="energy-fill"></div>
        </div>
        <div class="text-right">
            <p class="text-[9px] opacity-50 uppercase">AVG Viện</p>
            <p id="total-avg" class="text-xl font-black">0.00</p>
        </div>
    </div>

    <div class="main-container">
        <aside id="info-panel">
            <div id="welcome" class="text-center opacity-30 mt-20"><i class="fas fa-file-medical text-5xl mb-4"></i>
                <p>Chọn khoa phòng để xem phiếu đánh giá</p>
            </div>
            <div id="panel-data" class="hidden">
                <div class="flex justify-between items-end mb-4">
                    <h2 id="room-title" class="text-lg font-bold text-white uppercase"></h2>
                    <div id="room-avg" class="text-blue-400 font-bold"></div>
                </div>
                <div id="criteria-list"></div>
            </div>
        </aside>
        <main id="hospital-frame">
            <div id="layout-wrapper" class="relative">
                <img src="./images/layout_Tang1.png" id="hospital-map" class="max-h-[85vh]">
                <div id="hotspot-container"></div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = "LINK_WEB_APP_CUA_BAN_O_DAY";
        let masterData = {};
        let activeRoom = null;

        async function init() {
            const res = await fetch(API_URL);
            masterData = await res.json();
            let total = 0, count = 0;
            for (let k in masterData) { total += parseFloat(masterData[k].stats.avg); count++; }
            const avg = (total / count || 0).toFixed(2);
            document.getElementById('total-avg').innerText = avg;
            document.getElementById('energy-fill').style.width = (avg / 5 * 100) + "%";
            renderHotspots();
        }

        function renderHotspots() {
            const container = document.getElementById('hotspot-container');
            for (let id in masterData) {
                const room = masterData[id];
                const dot = document.createElement('div');
                dot.className = `hotspot lvl-${Math.round(room.stats.avg)}`;
                dot.style.left = room.posX + "%"; dot.style.top = room.posY + "%";
                dot.onclick = () => showInfo(id);
                dot.id = `hot-` + id;
                container.appendChild(dot);
            }
        }

        function showInfo(id) {
            activeRoom = id;
            document.getElementById('welcome').classList.add('hidden');
            document.getElementById('panel-data').classList.remove('hidden');
            const room = masterData[id];
            document.getElementById('room-title').innerText = room.title;
            document.getElementById('room-avg').innerText = "AVG: " + room.stats.avg;

            document.getElementById('criteria-list').innerHTML = room.standards.map((s, i) => `
                <div class="phuluc-card" id="item-${i}" onclick="activate(${i})">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold text-blue-400">${s.code}</span>
                        <div class="level-tag lvl-${s.level}">${s.level}</div>
                    </div>
                    <h3 class="text-xs font-bold leading-snug">${s.name}</h3>
                    
                    <div class="appendix-content">
                        <span class="label-pl">1. Thực trạng kiểm tra:</span>
                        <p class="mb-3 text-slate-300 italic">${s.desc || 'Chưa cập nhật'}</p>
                        
                        <span class="label-pl">2. Phương pháp áp dụng:</span>
                        <p class="mb-3">${s.method || 'Quan sát & Kiểm tra hồ sơ'}</p>
                        
                        <span class="label-pl">3. Giải trình xếp mức:</span>
                        <p class="mb-3">${s.reason || 'Đạt các tiểu mục tương ứng'}</p>
                        
                        <div class="flex justify-between items-center mt-4 pt-2 border-t border-slate-700">
                            <span class="text-[9px] opacity-50 text-white">Người chấm: ${s.staff}</span>
                            <button onclick="window.print()" class="text-blue-400 text-[10px]"><i class="fas fa-print"></i> In phiếu</button>
                        </div>
                    </div>
                </div>
            `).join('');
            activate(0);
        }

        function activate(idx) {
            document.querySelectorAll('.phuluc-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`item-${idx}`).classList.add('active');

            // Vẽ đường nối
            const h = document.getElementById(`hot-` + activeRoom);
            const a = document.getElementById(`item-${idx}`);
            const line = document.getElementById('connector-line');
            if (!h || !a) return;
            const hr = h.getBoundingClientRect(); const ar = a.getBoundingClientRect();
            const x1 = ar.right; const y1 = ar.top + 20;
            const x2 = hr.left + 9; const y2 = hr.top + 9;
            line.setAttribute('d', `M ${x1} ${y1} L ${x1 + 30} ${y1} L ${x1 + 30} ${y2} L ${x2} ${y2}`);
        }

        window.onload = init;
    </script>
</body>

</html>