<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>83 Tiêu chí BYT - Portal Vũ Quang Cường</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #030712;
            --primary: #3b82f6;
        }

        body {
            background: var(--bg);
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            margin: 0;
        }

        header {
            height: 75px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid #1e293b;
            display: flex;
            align-items: center;
            padding: 0 40px;
            z-index: 1000;
            position: relative;
            justify-content: space-between;
            backdrop-filter: blur(10px);
        }

        /* Mega Menu Cấp 1 (Lấy từ Cột A) */
        .mega-nav {
            display: flex;
            gap: 12px;
            height: 100%;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .nav-item {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0 15px;
            font-size: 11px;
            font-weight: 800;
            color: #94a3b8;
            transition: 0.3s;
            white-space: nowrap;
        }

        .nav-item:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Mega Content (Cấp 2 - Cột B & Cấp 3 - Cột C,D) */
        .mega-content {
            position: fixed;
            top: 75px;
            left: 0;
            width: 100vw;
            background: #0f172a;
            border-bottom: 3px solid var(--primary);
            display: none;
            grid-template-columns: repeat(4, 1fr);
            padding: 40px;
            gap: 30px;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.9);
            z-index: 999;
            max-height: 85vh;
            overflow-y: auto;
        }

        .nav-item:hover .mega-content {
            display: grid;
        }

        .mega-chapter-col {
            min-width: 0;
        }

        .mega-chapter-title {
            font-size: 10px;
            color: var(--primary);
            margin-bottom: 15px;
            border-bottom: 1px solid #1e293b;
            padding-bottom: 8px;
            text-transform: uppercase;
            font-weight: 900;
            line-height: 1.4;
        }

        .mega-item {
            font-size: 10px;
            padding: 8px 0;
            color: #64748b;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            line-height: 1.5;
            transition: 0.2s;
            cursor: pointer;
            display: flex;
            gap: 8px;
        }

        .mega-item b {
            color: #94a3b8;
            min-width: 35px;
        }

        .mega-item:hover {
            color: var(--primary);
            background: rgba(59, 130, 246, 0.08);
            padding-left: 10px;
        }

        .main-container {
            display: grid;
            grid-template-columns: 500px 1fr;
            height: calc(100vh - 75px);
        }

        #info-panel {
            background: #0b1120;
            border-right: 1px solid #1e293b;
            padding: 35px;
            overflow-y: auto;
        }

        #hospital-frame {
            position: relative;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .hotspot {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 4px solid #fff;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 500;
            animation: pulse-mega 2.5s infinite;
            background: var(--primary);
        }

        @keyframes pulse-mega {
            0% {
                box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.7);
            }

            100% {
                box-shadow: 0 0 0 45px rgba(59, 130, 246, 0);
            }
        }

        .contact-info {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(15, 23, 42, 0.9);
            padding: 15px 25px;
            border-radius: 15px;
            border: 1px solid rgba(59, 130, 246, 0.4);
            backdrop-filter: blur(10px);
        }
    </style>
</head>

<body>
    <header>
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center font-black">83</div>
            <div>
                <h1 class="text-xs font-black uppercase text-white leading-none">Chất lượng Bệnh viện</h1>
                <p class="text-[9px] text-blue-500 font-bold uppercase tracking-widest mt-1">Vũ Quang Cường Portal</p>
            </div>
        </div>
        <nav class="mega-nav" id="mega-nav-container"></nav>
        <div class="text-right">
            <p class="text-[8px] opacity-40 font-black uppercase">AVG Hệ thống</p><span id="total-avg"
                class="text-2xl font-black text-blue-500">4.00</span>
        </div>
    </header>

    <div class="main-container">
        <aside id="info-panel">
            <div id="welcome" class="text-center py-48 opacity-10"><i class="fas fa-sitemap text-8xl mb-6"></i>
                <p class="text-xs font-black uppercase tracking-widest text-white">Đang đồng bộ Menu từ Sheets...</p>
            </div>
            <div id="appendix-view" class="hidden">
                <div id="appendix-content"></div>
            </div>
        </aside>
        <main id="hospital-frame">
            <div id="layout-wrapper" class="relative">
                <img src="./images/layout_Tang1.png" id="hospital-map" class="max-h-[80vh] object-contain">
                <div id="hotspot-container"></div>
            </div>
            <div class="contact-info">
                <p class="text-[10px] text-blue-500 font-black uppercase tracking-widest mb-1">Chuyên gia Quản lý Chất
                    lượng</p>
                <p class="text-[14px] font-black text-white">Vũ Quang Cường</p>
                <p class="text-[12px] text-slate-400">0912.580.018</p>
            </div>
        </main>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby38k-cbBIZv4M0NVa29lWzKpeDzHavkFdbuJ3i0wJhNh0rS6cPh6k_UqOGB9_ImzoD/exec";
        let masterData = { menu: [], rooms: {} };

        async function init() {
            try {
                const res = await fetch(API_URL);
                masterData = await res.json();
                renderMegaMenu(masterData.menu);
                renderHotspots(masterData.rooms);
                document.getElementById('welcome').innerHTML = `<p class="text-[10px] uppercase font-bold text-blue-500">Đã nạp danh mục tiêu chí</p>`;
            } catch (e) {
                console.error(e);
                document.getElementById('welcome').innerHTML = `<p class="text-red-500 font-bold uppercase">Lỗi kết nối dữ liệu!</p>`;
            }
        }

        function renderMegaMenu(menu) {
            const nav = document.getElementById('mega-nav-container');
            const sections = [...new Set(menu.map(item => item.section))]; // Cột A

            nav.innerHTML = sections.map(secName => {
                const secId = secName.split('.')[0].replace(/\s/g, '');
                return `<div class="nav-item">${secName}<div class="mega-content" id="mega-${secId}"></div></div>`;
            }).join('');

            sections.forEach(secName => {
                const secId = secName.split('.')[0].replace(/\s/g, '');
                const megaBox = document.getElementById(`mega-${secId}`);
                const criteriaInSection = menu.filter(m => m.section === secName);
                const chapters = [...new Set(criteriaInSection.map(m => m.chapter))]; // Cột B

                megaBox.innerHTML = chapters.map(chapName => {
                    const items = criteriaInSection.filter(m => m.chapter === chapName);
                    return `
                        <div class="mega-chapter-col">
                            <h4 class="mega-chapter-title">${chapName}</h4>
                            <div class="item-list">
                                ${items.map(it => `
                                    <div class="mega-item" onclick="handleItemClick('${it.code}')">
                                        <b>${it.code}</b> <span>${it.name}</span> </div>
                                `).join('')}
                            </div>
                        </div>`;
                }).join('');
            });
        }

        function handleItemClick(code) {
            const roomId = Object.keys(masterData.rooms).find(r => masterData.rooms[r].standards.some(st => st.code === code));
            if (roomId) selectCriterion(roomId, code);
            else alert("Tiêu chí " + code + " chưa được chấm điểm.");
        }

        function renderHotspots(rooms) {
            const container = document.getElementById('hotspot-container');
            container.innerHTML = "";
            for (let id in rooms) {
                const room = rooms[id];
                const dot = document.createElement('div');
                dot.className = 'hotspot';
                dot.style.left = room.posX + "%"; dot.style.top = room.posY + "%";
                dot.onclick = () => selectCriterion(id, room.standards[0].code);
                container.appendChild(dot);
            }
        }

        function selectCriterion(roomId, code) {
            const s = masterData.rooms[roomId].standards.find(st => st.code === code);
            document.getElementById('welcome').classList.add('hidden');
            document.getElementById('appendix-view').classList.remove('hidden');
            document.getElementById('appendix-content').innerHTML = `
                <div class="bg-blue-600/20 p-6 rounded-2xl mb-6 border border-blue-500/30">
                    <p class="text-[10px] font-black text-blue-400 uppercase mb-1">Mã số: ${s.code}</p>
                    <h2 class="text-4xl font-black text-white">MỨC ${s.level}</h2>
                </div>
                <h3 class="text-white font-bold text-sm mb-8 uppercase leading-tight">${s.name}</h3>
                <div class="space-y-6 text-[12px]">
                    <p><b class="text-blue-500 block mb-1 uppercase">Thực trạng đánh giá:</b> <span class="text-slate-200 italic">${s.desc || 'N/A'}</span></p>
                    <p><b class="text-blue-500 block mb-1 uppercase">Giải trình xếp mức:</b> <span class="text-slate-400">${s.reason || 'N/A'}</span></p>
                </div>`;
        }
        window.onload = init;
    </script>
</body>

</html>