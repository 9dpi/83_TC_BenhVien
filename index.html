<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>83 Tiêu chí BYT - Portal Vũ Quang Cường</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg: #030712;
            --card: #0f172a;
            --primary: #3b82f6;
        }

        body {
            background: var(--bg);
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            margin: 0;
        }

        header {
            height: 75px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid #1e293b;
            display: flex;
            align-items: center;
            padding: 0 40px;
            z-index: 1000;
            position: relative;
            justify-content: space-between;
            backdrop-filter: blur(10px);
        }

        .mega-nav {
            display: flex;
            gap: 8px;
            height: 100%;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .nav-item {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0 18px;
            font-size: 11px;
            font-weight: 800;
            color: #94a3b8;
            transition: 0.3s;
        }

        .nav-item:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .mega-content {
            position: fixed;
            top: 75px;
            left: 0;
            width: 100vw;
            background: #0f172a;
            border-bottom: 3px solid var(--primary);
            display: none;
            grid-template-columns: repeat(5, 1fr);
            padding: 35px;
            gap: 25px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.9);
            z-index: 999;
            max-height: 80vh;
            overflow-y: auto;
        }

        .nav-item:hover .mega-content {
            display: grid;
        }

        .mega-chapter h4 {
            font-size: 10px;
            color: var(--primary);
            margin-bottom: 12px;
            border-bottom: 1px solid #1e293b;
            padding-bottom: 6px;
            text-transform: uppercase;
            font-weight: 900;
        }

        .mega-item {
            font-size: 10px;
            padding: 8px 0;
            color: #64748b;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            line-height: 1.5;
            transition: 0.2s;
            cursor: pointer;
        }

        .mega-item:hover {
            color: var(--primary);
            background: rgba(59, 130, 246, 0.08);
            padding-left: 8px;
            border-radius: 4px;
        }

        .main-container {
            display: grid;
            grid-template-columns: 480px 1fr;
            height: calc(100vh - 75px);
        }

        #info-panel {
            background: #0b1120;
            border-right: 1px solid #1e293b;
            padding: 35px;
            overflow-y: auto;
        }

        .hotspot {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 4px solid #fff;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 500;
            animation: pulse-mega 2.5s infinite;
            background: var(--primary);
        }

        @keyframes pulse-mega {
            0% {
                box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.7);
            }

            100% {
                box-shadow: 0 0 0 45px rgba(59, 130, 246, 0);
            }
        }

        .contact-info {
            position: absolute;
            bottom: 35px;
            right: 35px;
            background: rgba(15, 23, 42, 0.9);
            padding: 15px 25px;
            border-radius: 15px;
            border: 1px solid rgba(59, 130, 246, 0.4);
            backdrop-filter: blur(12px);
            z-index: 800;
        }

        .anchor-point {
            position: absolute;
            right: -15px;
            top: 50%;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 20px #fff;
            border: 3px solid var(--primary);
        }
    </style>
</head>

<body>
    <svg id="connection-svg" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[900]">
        <path id="connector-line" d="" fill="none" stroke="#3b82f6" stroke-width="3" stroke-dasharray="15,8"
            stroke-linecap="round" />
    </svg>

    <header>
        <div class="flex items-center gap-4 min-w-[300px]">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center font-black">83</div>
            <div>
                <h1 class="text-xs font-black uppercase text-white leading-none">Chất lượng Bệnh viện</h1>
                <p class="text-[9px] text-blue-500 font-black uppercase tracking-widest mt-1 italic">Vũ Quang Cường
                    Portal</p>
            </div>
        </div>
        <nav class="mega-nav" id="mega-nav-container"></nav>
        <div class="text-right min-w-[300px]">
            <p class="text-[8px] opacity-40 font-black uppercase">AVG Hệ thống</p>
            <div class="flex items-center gap-3 justify-end">
                <span id="total-avg" class="text-2xl font-black text-blue-500">0.00</span>
                <div class="w-16 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                    <div id="energy-fill" class="h-full bg-blue-500 w-0 transition-all duration-1000"></div>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside id="info-panel">
            <div id="welcome" class="text-center py-48 opacity-10"><i class="fas fa-database text-8xl mb-6"></i>
                <p class="text-[11px] font-black uppercase tracking-widest">Đang nạp dữ liệu...</p>
            </div>
            <div id="appendix-view" class="hidden relative">
                <div class="anchor-point" id="main-anchor"></div>
                <div id="appendix-content"
                    class="bg-slate-900/60 border border-blue-500/30 rounded-3xl p-8 shadow-2xl backdrop-blur-md"></div>
            </div>
        </aside>
        <main id="hospital-frame">
            <div id="layout-wrapper" class="relative">
                <img src="./images/layout_Tang1.png" id="hospital-map" class="max-h-[82vh] object-contain">
                <div id="hotspot-container"></div>
            </div>
            <div class="contact-info">
                <p class="text-[10px] text-blue-500 font-black uppercase tracking-widest mb-1">Chuyên gia Quản lý Chất
                    lượng</p>
                <p class="text-[15px] font-black text-white">Vũ Quang Cường</p>
                <p class="text-[12px] text-slate-400 font-semibold"><i
                        class="fas fa-phone-alt mr-2 text-blue-500"></i>0912.580.018</p>
            </div>
        </main>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby38k-cbBIZv4M0NVa29lWzKpeDzHavkFdbuJ3i0wJhNh0rS6cPh6k_UqOGB9_ImzoD/exec";
        let masterData = { menu: [], rooms: {} };

        async function init() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                masterData = data;

                renderDashboard(data.rooms);
                renderMegaMenu(data.menu);
                renderHotspots(data.rooms);

                document.getElementById('welcome').innerHTML = `<i class="fas fa-check-circle text-blue-500 text-6xl mb-4"></i><p class="text-[10px] uppercase font-bold">Dữ liệu đã sẵn sàng</p>`;
            } catch (e) {
                console.error(e);
                document.getElementById('welcome').innerHTML = `<p class="text-red-500 font-bold">LỖI NẠP DỮ LIỆU!</p>`;
            }
        }

        function renderMegaMenu(menu) {
            const nav = document.getElementById('mega-nav-container');
            const icons = { 'A': 'fa-user-injured', 'B': 'fa-id-card-alt', 'C': 'fa-hospital-user', 'D': 'fa-chart-pie', 'E': 'fa-hand-holding-heart' };
            const sections = ['A', 'B', 'C', 'D', 'E'];

            nav.innerHTML = sections.map(id => `
                <div class="nav-item">
                    <i class="fas ${icons[id]} mr-2 text-blue-500 text-[10px]"></i> PHẦN ${id}
                    <div class="mega-content" id="mega-${id}"></div>
                </div>
            `).join('');

            menu.forEach(s => {
                const secId = s.section.charAt(5);
                const megaBox = document.getElementById(`mega-${secId}`);
                if (!megaBox) return;

                let chapDiv = megaBox.querySelector(`[data-chap="${s.chapter}"]`);
                if (!chapDiv) {
                    chapDiv = document.createElement('div');
                    chapDiv.className = 'mega-chapter';
                    chapDiv.setAttribute('data-chap', s.chapter);
                    chapDiv.innerHTML = `<h4>${s.chapter}</h4><div class="item-list"></div>`;
                    megaBox.appendChild(chapDiv);
                }

                const item = document.createElement('div');
                item.className = 'mega-item';
                item.innerHTML = `<b>${s.code}</b>: ${s.name}`;
                item.onclick = (e) => {
                    e.stopPropagation();
                    const roomId = Object.keys(masterData.rooms).find(r =>
                        masterData.rooms[r].standards.some(st => st.code === s.code)
                    );
                    if (roomId) selectCriterion(roomId, s.code);
                    else alert("Tiêu chí này chưa có dữ liệu đánh giá tại khoa phòng nào.");
                };
                chapDiv.querySelector('.item-list').appendChild(item);
            });
        }

        function renderDashboard(rooms) {
            let total = 0, count = 0, roomCount = 0;
            for (let k in rooms) { total += parseFloat(rooms[k].stats.avg); roomCount++; }
            const avg = (total / roomCount || 0).toFixed(2);
            document.getElementById('total-avg').innerText = avg;
            document.getElementById('energy-fill').style.width = (avg / 5 * 100) + "%";
        }

        function renderHotspots(rooms) {
            const container = document.getElementById('hotspot-container');
            container.innerHTML = "";
            for (let id in rooms) {
                const room = rooms[id];
                const dot = document.createElement('div');
                dot.className = 'hotspot';
                dot.style.left = room.posX + "%"; dot.style.top = room.posY + "%";
                dot.onclick = () => selectCriterion(id, room.standards[0].code);
                dot.id = `hot-` + id;
                container.appendChild(dot);
            }
        }

        function selectCriterion(roomId, code) {
            const s = masterData.rooms[roomId].standards.find(st => st.code === code);
            document.getElementById('welcome').classList.add('hidden');
            document.getElementById('appendix-view').classList.remove('hidden');
            document.getElementById('appendix-content').innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <div class="bg-blue-600 px-4 py-1.5 rounded-lg text-[10px] font-black text-white">TIÊU CHÍ: ${s.code}</div>
                    <div class="text-right"><p class="text-[10px] opacity-40 font-bold uppercase">Mức đạt</p><p class="text-4xl font-black text-blue-500">${s.level}</p></div>
                </div>
                <h3 class="text-white font-black text-[16px] leading-tight mb-8 uppercase border-b border-slate-800 pb-6">${s.name}</h3>
                <div class="space-y-8 text-[13px] leading-relaxed">
                    <div><b class="text-blue-500 uppercase text-[10px] block mb-2">1. Thực trạng đánh giá</b><p class="italic text-slate-200 bg-black/50 p-5 rounded-2xl border-l-4 border-blue-600">${s.desc || 'N/A'}</p></div>
                    <div><b class="text-blue-500 uppercase text-[10px] block mb-2">2. Giải trình xếp mức</b><p class="text-slate-400 font-medium">${s.reason || 'N/A'}</p></div>
                </div>
                <div class="mt-10 pt-6 border-t border-slate-800 text-[10px] font-black text-slate-500 flex justify-between uppercase">
                    <span>Cán bộ: ${s.staff}</span>
                    <span class="text-blue-600 cursor-pointer" onclick="window.print()">In phiếu <i class="fas fa-print ml-1"></i></span>
                </div>
            `;
            drawConnector(roomId);
        }

        function drawConnector(roomId) {
            const h = document.getElementById(`hot-` + roomId);
            const a = document.getElementById(`main-anchor`);
            const line = document.getElementById('connector-line');
            if (!h || !a) return;
            const hr = h.getBoundingClientRect(); const ar = a.getBoundingClientRect();
            const x1 = ar.left + ar.width / 2; const y1 = ar.top + ar.height / 2;
            const x2 = hr.left + 20; const y2 = hr.top + 20;
            line.setAttribute('d', `M ${x1} ${y1} L ${x1 + 40} ${y1} L ${x1 + 40} ${y2} L ${x2} ${y2}`);
        }

        window.onload = init;
    </script>
</body>

</html>